<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"  %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<style>
.selected {
	background-color: #EDF8F9;
}
.search{
	background-image: url(/resources/images/Search.png);
	background-repeat: no-repeat;
	background-position: calc(100% - 10px) center;
	width: 285px;
	height: 30px;
	margin-left: 0px;
}
.treatment-center-wrap{
	width: 892px;
	display: flex;
    gap: 16px;
}
.patient-detail {
	width: 300px;
	height: 350px;
	flex-shrink: 0;
	margin-bottom: 20px;
}
.in-h2 {
	font-size: 14px !important;
}
.treatment-tab-wrap {
	display: flex;
    gap: 24px;
    justify-content: space-evenly;
    margin-top: -32px;
}
.rounds-tab {
	margin-top: 32px;
    border-top-right-radius: 18px;
    border-top-left-radius: 18px;
    border: 1px solid var(--border, #E0E8E6);
    border-bottom: none;
    padding: 16px;
    background: var(--white, #FFF);
    width: 35%;
    padding: 4px;
    text-align: center;
    color: #000;
    cursor: pointer;
}
.patient-chart{
	width: 580px;
	height: 320px;
	flex-shrink: 0;
	margin-bottom: 20px;
}
.patient-chart-list{
    width: 120px;
    margin: 0px -16px -16px -16px;
    padding: 16px 0px 16px 16px;
    overflow-y: scroll;
    overflow-x: hidden;
}
.treatment-detail{
	height: 470px;
}
.treatment-chart-header {
	border-bottom: 1px solid #EBEFF0;
}
.treatment-chart {
    width: 360px;
    height: 400px;
}
.treatment-chart-list{
    height: 284px;
    width: 155px;
    margin: 0px -16px -16px -16px;
    padding: 8px 16px 16px 16px;
    border-right: 1px solid var(--border, #EBEFF0);
    overflow-y: scroll;
    overflow-x: hidden;
}
.treatment-chart-detail {
    width: 543px;
    height: 267px;
    margin: 8px -17px -16px 16px;
    padding: 0px 16px 16px 16px;
    border-radius: 0px 0px 24px 0px;
}
.treatment-chart-body-top {
	padding-top: 8px;
}
.clinic-history-body{
	width: 400px;
	height: 300px;
	overflow-x: hidden;
	overflow-y: scroll;
	padding: 16px;
}
.h1-default {
	text-align: center;
	width: 100%;
	margin-top: 90px;
	color: #8D9EA5 !important;
	font-size: 2em !important;
}
.calendar-wrap {
	display: flex;
    gap: 24px;
    justify-content: space-evenly;
}
.nurse-record-tab {
	margin-top: 24px;
	display: flex;
	justify-content: space-evenly;
}
.nurse-record {
    height: 392px;
}
.nurse-record-element {
	border-top-right-radius: 18px;
    border-top-left-radius: 18px;
    border: 1px solid var(--border, #E0E8E6);
    border-bottom: none;
    padding: 16px;
    background: var(--white, #FFF);
    width: 25%;
    padding: 1px;
    text-align: center;
    cursor: pointer;
    color: #000;
}
.icon-calendar {
	width: 48px;
	height: 48px;
}
.icon-stethoscope {
	width: 42px;
	height: 42px;
}

.clinic-history-head {
	border-right: 1px solid var(--border, #EBEFF0);
	height: 300px;
    overflow-y: scroll;
    width: 120px;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
$(function(){
	var header = $("meta[name='_csrf_header']").attr("content");
	var token = $("meta[name='_csrf']").attr("content");
	
	//치료완료 환자리스트 출력
	treatmentPatientList();
	
	function treatmentPatientList(){
		$.ajax({
			url: '/treatment/treatmentPatientList',
			dataType: 'json',
			type: 'post',
			beforeSend:function(xhr){
				xhr.setRequestHeader(header,token);
			},
			success: function(result){
				console.log("치완환자 출력!!", result);	
				
				$.each(result, function(i){
						let str = "";
						str += '<tr class="tr-padding tr-paInfo" data-paNo="'+ result[i].paNo +'">';
						str += '<td class="td-padding">'+(i + 1)+'</td>';
						str += '<td height="48px" class="td-padding">'+ truncateText(result[i].paName) +'</td>';
						str += '<td class="td-padding">'+ formatResidentNumber(result[i].paReg) +'</td>';
						//str += '<th class="td-padding">';
						//str += '</th>';
						str += '</tr>';
						
						$('#patient-list-table').append(str);
					});
			},
			error: function(xhr, status, error){
				console.log('Error:', xhr, status, error);
			}
		});
	}
	
	// 특정 환자 누를 때
	$(document).on("click", ".tr-paInfo", function() {
		console.log("환자를 클릭!!");
		
		//환자번호 가져오기
		let paNo = $(this).data('pano');
		currentPaNo = paNo;
		
		//환자정보갱신
		updatePaInfo(paNo);
		//환자의 과거진료내역
		updatePastClinicChart();
	});
	
	// 환자 정보 갱신
    function updatePaInfo(paNo){
    	$.ajax({
    		url: '/treatment/selectTreatmentPatientInfo',
    		data: {'paNo' : paNo},
    		type: 'post',
    		dataType: 'json',
    		beforeSend: function(xhr){
    			xhr.setRequestHeader(header,token);
    		},
    		success: function(result){
    			console.log("클릭한 환자 정보 가져오기 : ", result);
    			let patientInfo = $('.patient-info-div');
    			patientInfo.find('h2').eq(0).text('이름 : ' + result.paName);
    			patientInfo.find('h2').eq(1).text('성별 : ' + result.paSex);
    			patientInfo.find('h2').eq(2).text('나이 : ' + getAge(formatResidentNumber(result.paReg)));
    			patientInfo.find('h2').eq(3).text('연락처 : ' + result.paPh);
    			patientInfo.find('h2').eq(4).text('주소 : ' + result.paAdd1 + ' ' + result.paAdd2);
    			patientInfo.find('h2').eq(5).text('혈액형 : ' + result.paBldType);
    			patientInfo.find('h2').eq(6).text('키 : ' + result.paHeight + 'cm');
    			patientInfo.find('h2').eq(7).text('몸무게 : ' + result.paWeight + 'kg');
    		},
    		error: function(xhr, status, error){
    			console.log('Error:', xhr, status, error);
    		}
    	});
    }
	
 	// 과거 진료 내역 심플 리스트 갱신
    function updatePastClinicChart(){
    	$.ajax({
    		url: '/clinic/simpleClinicChartList',
    		data: {'paNo' : currentPaNo},
    		type: 'post',
    		dataType: 'json',
    		beforeSend: function(xhr){
    			xhr.setRequestHeader(header,token);
    		},
    		success: function(result){
    			console.log("클릭한 환자 과거진료내역!!!", result);
    			$('.clinic-history-head').html("");
    			
    			let firstClinicNo = '';
    			let str ="";
    			
    			$.each(result.clinicChartVOList, function(i, vo){
    				if(i === 0){
	   					firstClinicNo = vo.clinicNo;
	   					str += '<div class="patient-chart-list" data-clinicno="'+ vo.clinicNo +'">';
    				}else{
	   					str += '<div class="patient-chart-list" data-clinicno="'+ vo.clinicNo +'">';
    				}
   					str += '<div data-clinicNo"'+vo.clinicNo+'" class="patient-chart-list" style="font-size:17px">' + vo.clinicDt + '</div>';
   					str += '<div>';
//    					str += `
// 	   	   					<div class="patient-chart-list" data-clinicno=\${vo.clinicNo}>
// 	   	   						<div class="dduk-row" style="font-size:17px">\${vo.clinicDt}</div>
// 	   	   					</div>
//    					`;
    			});
   					$('.clinic-history-head').append(str);
    			
    		}
    	});
 	}
 	
	// 이름 등이 글자를 제어하고 싶을 때 maxLength까지만 표시
	function truncateText(text, maxLength) {
		if (text.length > maxLength) {
			return text.slice(0, maxLength) + '...';
		} else {
		    return text;
		}
	}
	
	// 날짜형식 데이터를 넣으면 yyyy-MM-dd(요일) 로 변환해주는 함수
	function formatDateString(dateString) {
		// 요일먼저 얻기
		const week = ['일', '월', '화', '수', '목', '금', '토'];
		const dayOfWeek = week[new Date(dateString).getDay()];
		
		const dateData = new Date(dateString);
		let year = dateData.getFullYear();
		let month = dateData.getMonth(); 
		let date = dateData.getDate()
		
		let dateStr = `\${year}-\${month}-\${date}(\${dayOfWeek})`;
		
		return dateStr;
	}
	
	// 주민번호를 생년월일로 변환
	function formatResidentNumber(residentNumber) {
		
		// 00~39년생은 20을 붙이고 그 외엔 19를 붙인다
	    let year = "";
	    if(Number(residentNumber.substr(0,1)) <= 3){
	    	year += "20";
	    } else {
	    	year += "19";
	    }
	    year += residentNumber.substr(0,2);
	    
	    
	    let month = residentNumber.substr(2,2);
	    let day = residentNumber.substr(4,2);
	    
	    let birthDay = year + "-" + month + "-" + day;
	    return birthDay;
	}
	
	// 주민번호로 만나이 계산
	function getAge(paBirthDay) {
		
		// 현재날짜, 생일로 날짜계산
	    const currentDate = new Date();
	    const birthdateDate = new Date(paBirthDay);
	    let age = currentDate.getFullYear() - birthdateDate.getFullYear();

	    // 현재와 생일의 월, 날짜 얻어주기
    	const currentMonth = currentDate.getMonth();
    	const birthdateMonth = birthdateDate.getMonth();
    	const currentDay = currentDate.getDate();
    	const birthdateDay = birthdateDate.getDate();

    	// 현재 날짜가 생년월일보다 앞 날짜면 아직 생일이 오지 않은 상태임(한살빼기)
    	if (currentMonth <= birthdateMonth && currentDay < birthdateDay) {
       		age--;
    	}

	    return age;
	}
});
</script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<div class="dduk-body-border patient-list">
	<div>
		<div class="dduk-title-area" style="margin-bottom: 0px;">
			<h2>치료 완료 환자</h2>
		</div>
		<div class="d-flex">
			<input type="text" id="search" class="search dduck-input" placeholder="환자 이름/번호를 입력해 주세요" autocomplete="off">
		<div class="autocomplete"></div>
		</div>
		<div class="dduk-x-pd8">
			<table class="patient-list-table" id="patient-list-table" style="text-align: center;">
				<tr class="tr-padding">
					<th class="td-padding gray-text" style="width:20px;">No</th>
					<th class="td-padding gray-text paName" style="width:90px;">이름</th>
					<th class="td-padding gray-text" style="width:110px">생년월일</th>
				</tr>
			</table>
		</div>	
	</div>
</div>
<div>
	<div class="treatment-center-wrap">
		<div class="dduk-body-border patient-detail">
			<div class="dduk-title-area">
				<h2>환자 정보 조회</h2>
			</div>
			<div class="patient-info-div">
				<div class="dduk-row">
					<h2 class="in-h2" style="width:100%">이름 : </h2>
				</div>
				<div class="dduk-row">
					<h2 class="in-h2" style="width:50%">성별 : </h2>
					<h2 class="in-h2" style="width:50%">나이 : </h2>
				</div>
				<div class="dduk-row">
					<h2 class="in-h2" style="width:100%">연락처 : </h2>
				</div>
				<div class="dduk-row">
					<h2 class="in-h2" style="width:100%">주소 : </h2>
				</div>
				<div class="dduk-row">
					<h2 class="in-h2" style="width:33%">혈액행 : </h2>
				</div>
				<div class="dduk-row">
					<h2 class="in-h2" style="width:50%">키 : </h2>
					<h2 class="in-h2" style="width:50%">몸무게 : </h2>
				</div>
			</div>
		</div>
	<div>
		<div class="dduk-row treatment-tab-wrap">
			<div class="rounds-tab" id="clinicHistory">진료내역</div>
			<div class="rounds-tab tab-active" id="admissionHistory">입원내역</div>
		</div>
		<div class="dduk-inner-border patient-chart">
			<div class="dduk-row clinic-history-list">
				<div class="clinic-history-head">
					<!-- 진료내역 날짜 들어오는곳 -->
				</div>
				<div class="clinic-history-body">
					<!-- 진료내역 가져오기 -->
					<h1 class="h1-default">환자를 선택해주세요</h1>
				</div>
			</div>
		</div>
	</div>
	</div>
	<div>
		<div class="dduk-body-border treatment-detail" style="position: relative;">
			<div class="treatment-chart-record-wrap">
				<div class="dduk-title-area treatment-chart-header">
					<div class="d-flex">
						<h2>치료차트</h2>
					</div>
				</div>
				<div class="d-flex treatment-chart-body">
					<div class="treatment-chart-list">
						
					</div>
	
					<div class="treatment-chart-detail">
						<div class="treatment-chart-body-top">
							<div class="calendar-wrap">
								<div class="dduk-row">
									<img class="icon-stethoscope" src="/resources/images/icons/stethoscope.png">
									<div class="date-wrap">
										<div>담당의사</div>
										<div class="empName">김영남</div>
									</div>
								</div>
			
								<div class="dduk-row"> 
									<img class="icon-calendar" src="/resources/images/icons/calendar.png">
									<div class="date-wrap">
										<div>치료일시</div>
										<div class="inDt">2023-12-22</div>
									</div>
								</div>
	
								<div class="dduk-row">
									<img class="icon-calendar" src="/resources/images/icons/calendar.png">
									<div class="date-wrap">
										<div>퇴원예정일</div>
										<div class="expOutDt">2023-12-28</div>
									</div>
								</div>
	
							</div>
						</div>
						<div class="treatment-chart-cont flex-d-col">
							<div class="treatment-chart-write-title">
								<h2>차트작성</h2>
								<button class="dduk-btn-info btn-treatment-chart-save">저장</button>
							</div>
							<div class="dduk-row">
								<textarea id="treatmentCont" class="dduck-input"></textarea>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="nurse-wrap">
			
	<div class="dduk-body-border nurse-chart">
		<div class="dduk-title-area nurse-chart-head">
			<h2>통계</h2>
			<input type="text" name="datepicker-nurse-chart" id="datepickerNurseChart" style="display: none">
		</div>
		<div class="nurse-chart-body">
			<div class="nurse-chart-list">
				<div class="nurse-chart-list-date">통계통계</div>
			</div>
		</div>
	</div>
	
	<div class="nurse-record-tab">
		<div class="nurse-record-element">통계</div>
		<div class="nurse-record-element tab-active">통계</div>
		<div class="nurse-record-element tab-active">통계</div>
	</div>
	<div class="dduk-body-border nurse-record">
		<div class="nurse-record-body">통계통계</div>
	</div>
	
</div>